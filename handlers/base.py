from aiogram import Router, F
from aiogram.types import Message, InlineKeyboardMarkup, InlineKeyboardButton, FSInputFile
from aiogram.filters import Command
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup


class ViolationStates(StatesGroup):
    """–°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞—Ä—É—à–µ–Ω–∏–π"""
    waiting_for_voice = State()


class BaseHandler:
    """–ë–∞–∑–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å –æ—Å–Ω–æ–≤–Ω–æ–π –ª–æ–≥–∏–∫–æ–π –±–æ—Ç–∞"""

    def __init__(self):
        self.router = Router()
        self._setup_handlers()

    def _setup_handlers(self):
        """–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏"""
        self.router.message.register(self.start_command, Command("start"))
        self.router.message.register(self.help_command, Command("help"))
        self.router.callback_query.register(
            self.new_violation_callback, F.data == "new_violation")

    async def start_command(self, message: Message, state: FSMContext):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
        welcome_text = """
üîç **–ü—Ä–∏–≤–µ—Ç, –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä!**

–Ø –ø–æ–º–æ–≥—É –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—Ä—É—à–µ–Ω–∏—è –∏ –Ω–∞–π—Ç–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã.

üí° **–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
1. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–°–æ–æ–±—â–∏—Ç—å –æ –Ω–∞—Ä—É—à–µ–Ω–∏–∏"
2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –Ω–∞—Ä—É—à–µ–Ω–∏—è
3. –ü–æ–ª—É—á–∏—Ç–µ –∞–Ω–∞–ª–∏–∑ —Å –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–æ–π —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –∏ —Å—Å—ã–ª–∫–∞–º–∏ –Ω–∞ –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

‚ùó **–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:**
‚Ä¢ –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–¥–æ 60 —Å–µ–∫—É–Ω–¥)
‚Ä¢ –¢–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è

–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å:
        """
        image_path = "assets/welcome_image.jpg"
        photo = FSInputFile(image_path)
        keyboard = self._create_main_keyboard()
        await message.answer_photo(
            photo=photo,
            caption=welcome_text,
            reply_markup=keyboard,
            parse_mode="Markdown"
        )
        await state.set_state(ViolationStates.waiting_for_voice)

    async def help_command(self, message: Message):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help"""
        help_text = """
üìã **–°–ø—Ä–∞–≤–∫–∞ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –±–æ—Ç–∞**

**–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:**
/start - –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
/help - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É

**–ü—Ä–æ—Ü–µ—Å—Å —Ä–∞–±–æ—Ç—ã:**
1. **–û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞—Ä—É—à–µ–Ω–∏—è** - –ù–∞–∂–º–∏—Ç–µ "–°–æ–æ–±—â–∏—Ç—å –æ –Ω–∞—Ä—É—à–µ–Ω–∏–∏" –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
2. **–û–±—Ä–∞–±–æ—Ç–∫–∞** - –ë–æ—Ç –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç —Ä–µ—á—å –≤ —Ç–µ–∫—Å—Ç –∏ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –Ω–∞—Ä—É—à–µ–Ω–∏–µ
3. **–†–µ–∑—É–ª—å—Ç–∞—Ç** - –í—ã –ø–æ–ª—É—á–∏—Ç–µ:
   ‚Ä¢ –°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è
   ‚Ä¢ –°—Å—ã–ª–∫—É –Ω–∞ –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç
   ‚Ä¢ –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—é

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –≥–æ–ª–æ—Å–æ–≤—ã–º —Å–æ–æ–±—â–µ–Ω–∏—è–º:**
‚Ä¢ –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: –¥–æ 60 —Å–µ–∫—É–Ω–¥
‚Ä¢ –Ø–∑—ã–∫: —Ä—É—Å—Å–∫–∏–π
‚Ä¢ –ö–∞—á–µ—Å—Ç–≤–æ: —á–µ—Ç–∫–∞—è —Ä–µ—á—å

**–ü—Ä–∏–º–µ—Ä—ã –Ω–∞—Ä—É—à–µ–Ω–∏–π:**
‚Ä¢ "–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–≥–Ω–µ—Ç—É—à–∏—Ç–µ–ª—è –≤ –ø–æ–º–µ—â–µ–Ω–∏–∏"
‚Ä¢ "–ù–µ–∏—Å–ø—Ä–∞–≤–Ω–∞—è —ç–ª–µ–∫—Ç—Ä–æ–ø—Ä–æ–≤–æ–¥–∫–∞"
‚Ä¢ "–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∑–Ω–∞–∫–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∑–∞–Ω–æ–≤–æ.
        """

        keyboard = self._create_main_keyboard()
        await message.answer(help_text, reply_markup=keyboard, parse_mode="Markdown")

    async def new_violation_callback(self, callback_query, state: FSMContext):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ '–°–æ–æ–±—â–∏—Ç—å –æ –Ω–∞—Ä—É—à–µ–Ω–∏–∏'"""
        await callback_query.answer()

        instruction_text = """
üé§ **–û—Ç–ø—Ä–∞–≤—å—Ç–µ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ**

–û–ø–∏—à–∏—Ç–µ –Ω–∞—Ä—É—à–µ–Ω–∏–µ –≥–æ–ª–æ—Å–æ–≤—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º. 

‚ùó**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
‚Ä¢ –ì–æ–≤–æ—Ä–∏—Ç–µ —á–µ—Ç–∫–æ –∏ –ø–æ–Ω—è—Ç–Ω–æ
‚Ä¢ –û–ø–∏—à–∏—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –Ω–∞—Ä—É—à–µ–Ω–∏–µ
‚Ä¢ –£–∫–∞–∂–∏—Ç–µ –º–µ—Å—Ç–æ –∏ –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞

**–ü—Ä–∏–º–µ—Ä—ã:**
‚Ä¢ "–í —Ü–µ—Ö–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–≥–Ω–µ—Ç—É—à–∏—Ç–µ–ª—å"
‚Ä¢ "–ù–∞ –ª–µ—Å—Ç–Ω–∏—Ü–µ –Ω–µ—Ç –ø–µ—Ä–∏–ª"
‚Ä¢ "–≠–ª–µ–∫—Ç—Ä–æ–ø—Ä–æ–≤–æ–¥–∫–∞ –Ω–µ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–∞"

‚è±Ô∏è **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** 60 —Å–µ–∫—É–Ω–¥
        """

        await state.set_state(ViolationStates.waiting_for_voice)
        await callback_query.message.answer(instruction_text, parse_mode="Markdown")

    def _create_main_keyboard(self) -> InlineKeyboardMarkup:
        """–°–æ–∑–¥–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–æ–π '–°–æ–æ–±—â–∏—Ç—å –æ –Ω–∞—Ä—É—à–µ–Ω–∏–∏'"""
        keyboard = InlineKeyboardMarkup(
            inline_keyboard=[
                [
                    InlineKeyboardButton(
                        text="üö® –°–æ–æ–±—â–∏—Ç—å –æ –Ω–∞—Ä—É—à–µ–Ω–∏–∏",
                        callback_data="new_violation"
                    )
                ]
            ]
        )
        return keyboard

    def get_router(self):
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–æ—É—Ç–µ—Ä –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–µ"""
        return self.router
